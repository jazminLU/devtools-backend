name: Backend CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      build_image:
        description: 'Build and push Docker image'
        required: false
        default: 'true'
        type: boolean
      deploy_dev:
        description: 'Deploy to dev cluster'
        required: false
        default: 'false'
        type: boolean

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 558497223978
  ECR_REGISTRY: 558497223978.dkr.ecr.us-east-1.amazonaws.com
  IMAGE_REPO: moon-backend
  HELM_CHART_REPO: devtools-playground
  HELM_CHART_NAME: devtools-playground-backend
  EKS_CLUSTER_NAME: moon-dev-eks
  SONAR_ORG: jazminlu
  SONAR_PROJECT_KEY: jazminLU_devtools-backend
  AWS_ROLE_ARN: arn:aws:iam::558497223978:role/github-actions-devtools-backend

jobs:
  lint-and-test:
    uses: ./.github/workflows/cicd-templates/lint-and-test.yml
    with:
      python_version: '3.11'
      test_files: 'tests/test_main.py tests/test_dictionary.py tests/test_shopping.py tests/test_words.py'

  sonarcloud-analysis:
    needs: lint-and-test
    uses: ./.github/workflows/cicd-templates/sonarcloud-analysis.yml
    with:
      python_version: '3.11'
      sonar_org: ${{ env.SONAR_ORG }}
      sonar_project_key: ${{ env.SONAR_PROJECT_KEY }}
      test_files: 'tests/test_main.py tests/test_dictionary.py tests/test_shopping.py tests/test_words.py'
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  build-and-push:
    needs: sonarcloud-analysis
    uses: ./.github/workflows/cicd-templates/build-and-push.yml
    with:
      aws_region: ${{ env.AWS_REGION }}
      ecr_registry: ${{ env.ECR_REGISTRY }}
      image_repo: ${{ env.IMAGE_REPO }}
      aws_role_arn: ${{ env.AWS_ROLE_ARN }}
      dockerfile_path: './Dockerfile'
      context_path: '.'
    secrets:
      AWS_ROLE_SESSION_NAME: 'GitHubActions-Backend-Build'

  deploy-dev:
    needs: build-and-push
    if: success()
    uses: ./.github/workflows/cicd-templates/deploy-dev.yml
    with:
      aws_region: ${{ env.AWS_REGION }}
      ecr_registry: ${{ env.ECR_REGISTRY }}
      image_repo: ${{ env.IMAGE_REPO }}
      eks_cluster_name: ${{ env.EKS_CLUSTER_NAME }}
      helm_chart_repo: ${{ env.HELM_CHART_REPO }}
      helm_chart_name: ${{ env.HELM_CHART_NAME }}
      helm_chart_version: '1.0.0'
      namespace: 'devtools-playground'
      values_file: 'helm/values-moon-dev.yaml'
      aws_role_arn: ${{ env.AWS_ROLE_ARN }}
      helm_version: '3.13.0'
    secrets:
      AWS_ROLE_SESSION_NAME: 'GitHubActions-Backend-Deploy'
